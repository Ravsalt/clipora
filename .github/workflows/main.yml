name: üß† Clipora API /health Monitor

on:
  schedule:
    - cron: "*/2 * * * *" # Every 2 minutes
  workflow_dispatch:       # Manual run for testing

jobs:
  health-check:
    runs-on: ubuntu-latest

    steps:
      - name: üöÄ Curl + Validate JSON
        run: |
          echo "üî• Checking Clipora /health endpoint..."

          RESPONSE=$(curl -s -w "\n%{http_code}" \
                          -H "Accept: application/json" \
                          -H "User-Agent: CliporaMonitor/1.0" \
                          --max-time 10 \
                          https://clipora.onrender.com/health)

          BODY=$(echo "$RESPONSE" | head -n 1)
          STATUS=$(echo "$RESPONSE" | tail -n 1)

          echo "üì° HTTP Response Code: $STATUS"
          echo "üì¶ Response Body: $BODY"

          if [[ "$STATUS" -ne 200 ]]; then
            echo "::error ::‚ùå API is DOWN ‚Äî HTTP $STATUS"
            exit 1
          fi

          echo "$BODY" | jq -e '.status == "ok"' > /dev/null

          if [[ $? -ne 0 ]]; then
            echo "::error ::‚ùå Health check failed ‚Äî .status != 'ok'"
            exit 1
          else
            echo "::notice ::‚úÖ Clipora API is healthy"
          fi
